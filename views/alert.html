{% extends 'layout.html' %}
{% block style %}
{% endblock %}
{% block content %}
<div class="px-[4vw] py-[2vh]">
    <div class="top text-xl font-bold mb-[2vw] text-center">
        <h1>ì•Œë¦¼ LIST</h1>
    </div>
    <!-- alert list -->
    <div id="alert-container" class="space-y-[4vw]"></div>
</div>
{% endblock %}
{% block script %}
<script>
    let lastFetched = '';

    async function fetchAlertsAndRender() {
        const container = document.getElementById('alert-container');

        try {
            const res = await fetch('/alert/list');
            const alertData = await res.json();
            const serialized = JSON.stringify(alertData);

            if (serialized === lastFetched) return;
            lastFetched = serialized;
            container.innerHTML = '';

            Object.keys(alertData).forEach(dateKey => {
                // ë‚ ì§œ ë¼ë²¨
                const dateLabel = document.createElement('div');
                dateLabel.className = 'text-[4vw] font-semibold text-white';
                dateLabel.textContent = dateKey;
                container.appendChild(dateLabel);

                // ì•Œë¦¼ ì¹´ë“œ
                const card = document.createElement('div');
                card.className = 'bg-white rounded-[3.5vw] p-[4vw] text-[4vw] shadow text-gray-800 space-y-[1vw]';

                alertData[dateKey].forEach(alert => {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between cursor-pointer hover:bg-gray-100 px-2 py-1 rounded';

                    const message = document.createElement('div');
                    message.textContent = alert.message;

                    const time = document.createElement('div');
                    time.className = 'text-[3.2vw] text-right text-gray-500';
                    time.textContent = alert.created_at;

                    row.appendChild(message);
                    row.appendChild(time);

                    // í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì´ë™
                    row.addEventListener('click', async () => {
                        try {
                            const dlId = alert.dl_id;
                            const res = await fetch(`/alert/detail-info?dl_id=${dlId}`);
                            const data = await res.json();

                            if (data && data.re_num) {
                                window.location.href = `/detail?re_num=${data.re_num}`;
                            } else {
                                alert('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        } catch (err) {
                            console.error('âŒ ìƒì„¸ì •ë³´ fetch ì‹¤íŒ¨:', err);
                            alert('ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    });

                    card.appendChild(row);
                });

                container.appendChild(card);
            });
        } catch (err) {
            console.error('ğŸš¨ ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
            container.innerHTML = '<p class="text-red-500">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchAlertsAndRender();             // ìµœì´ˆ ë Œë”ë§
        setInterval(fetchAlertsAndRender, 5000); // ì‹¤ì‹œê°„ ê°±ì‹ 
    });
</script>
{% endblock %}